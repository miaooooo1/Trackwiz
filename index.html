<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Dark background */
            color: #e0e0e0; /* Light text */
        }
        /* Lilac accent color */
        .accent-lilac {
            --tw-bg-opacity: 1;
            background-color: rgba(160, 110, 200, var(--tw-bg-opacity)); /* Lilac shade */
            --tw-text-opacity: 1;
            color: rgba(255, 255, 255, var(--tw-text-opacity));
        }
        .accent-lilac-text {
             --tw-text-opacity: 1;
             color: rgba(190, 150, 220, var(--tw-text-opacity)); /* Lighter Lilac for text */
        }
         .accent-lilac-border {
             --tw-border-opacity: 1;
             border-color: rgba(160, 110, 200, var(--tw-border-opacity));
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: #2a2a2a; /* Darker modal background */
            margin: 10% auto; /* Adjusted margin for potentially taller modal */
            padding: 20px;
            border: 1px solid #444;
            width: 90%; /* Wider for routine management */
            max-width: 600px; /* Increased max-width */
            border-radius: 8px;
            animation: slideIn 0.3s ease-out;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        /* Input styling */
        input[type="text"], input[type="datetime-local"], input[type="date"], input[type="url"], input[type="time"], select, textarea { /* Added time */
            background-color: #333;
            border: 1px solid #555;
            color: #e0e0e0;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            width: 100%;
            margin-top: 0.25rem;
            margin-bottom: 0.75rem;
            /* Fix for time input text color in dark mode */
             color-scheme: dark;
        }
         input[type="file"] { /* Kept for exam syllabus */
            background-color: #333;
            border: 1px solid #555;
            color: #e0e0e0;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
             margin-top: 0.25rem;
            margin-bottom: 0.75rem;
         }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2a2a2a; }
        ::-webkit-scrollbar-thumb { background-color: #555; border-radius: 4px; border: 2px solid #2a2a2a; }
        ::-webkit-scrollbar-thumb:hover { background-color: #777; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-20px); opacity: 0; } }
        .fade-out { animation: fadeOut 0.3s ease-out forwards; }
        .slide-out { animation: slideOut 0.3s ease-out forwards; }
        .notification-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(160, 110, 200, 0.9); color: white; padding: 12px 20px;
            border-radius: 8px; z-index: 100; font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); display: none;
            animation: fadeIn 0.5s, fadeOut 0.5s 4.5s forwards;
        }
        /* Styling for weekly view */
        .day-column { min-height: 100px; } /* Ensure columns have some height */

        /* Styling for Status Section */
        #classStatusSection .status-label {
            font-size: 0.8rem;
            color: #a0aec0; /* gray-500 */
            margin-bottom: 0.1rem;
        }
        #classStatusSection .status-value {
            font-size: 1rem;
            font-weight: 500;
            color: #e0e0e0; /* gray-200 */
        }
         #classStatusSection .status-value.highlight {
             color: rgba(190, 150, 220, 1); /* accent-lilac-text */
             font-weight: 600;
         }
        #countdownTimer {
            font-size: 1.3rem;
            font-weight: 600;
            color: rgba(190, 150, 220, 1); /* accent-lilac-text */
            letter-spacing: 0.05em;
        }


    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-gray-900 shadow-md p-4 sticky top-0 z-40">
        <h1 class="text-2xl font-bold text-center accent-lilac-text">Academic Dashboard</h1>
    </header>

    <main class="flex-grow container mx-auto p-4 space-y-6">

        <section id="classStatusSection" class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold accent-lilac-text mb-3">Class Status</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center md:text-left">
                <div>
                    <p class="status-label">Current Class</p>
                    <p id="currentClassInfo" class="status-value truncate" title="No current class">--</p>
                </div>
                <div>
                    <p class="status-label">Next Class Today</p>
                    <p id="nextClassInfo" class="status-value truncate" title="No more classes today">--</p>
                </div>
                <div>
                    <p class="status-label">Time Until Next</p>
                    <p id="countdownTimer" class="status-value">--:--:--</p>
                </div>
            </div>
        </section>

        <section id="classes" class="bg-gray-800 p-4 rounded-lg shadow-lg transition-all duration-300 hover:shadow-xl">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold accent-lilac-text">This Week's Classes</h2>
                <button id="manageRoutineBtn" class="accent-lilac px-3 py-1 rounded-md text-sm font-medium hover:bg-opacity-80 transition-colors duration-200">Manage Routine</button>
            </div>
            <div id="weeklyClassView" class="space-y-4">
                <p class="text-gray-400 italic">Loading weekly schedule...</p>
            </div>
        </section>

        <section id="exams" class="bg-gray-800 p-4 rounded-lg shadow-lg transition-all duration-300 hover:shadow-xl">
             <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold accent-lilac-text">Exams</h2>
                <button id="addExamBtn" class="accent-lilac px-3 py-1 rounded-md text-sm font-medium hover:bg-opacity-80 transition-colors duration-200">+</button>
            </div>
            <div id="examList" class="space-y-3">
                 <p class="text-gray-400 italic">No exams scheduled yet.</p>
            </div>
        </section>

        <section id="notes" class="bg-gray-800 p-4 rounded-lg shadow-lg transition-all duration-300 hover:shadow-xl">
             <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold accent-lilac-text">Class Notes</h2>
                <button id="addNoteBtn" class="accent-lilac px-3 py-1 rounded-md text-sm font-medium hover:bg-opacity-80 transition-colors duration-200">+</button>
            </div>
             <div id="noteList" class="space-y-3">
                 <p class="text-gray-400 italic">No notes added yet.</p>
            </div>
        </section>

        <section id="assignments" class="bg-gray-800 p-4 rounded-lg shadow-lg transition-all duration-300 hover:shadow-xl">
             <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold accent-lilac-text">Assignments</h2>
                 <button id="addAssignmentBtn" class="accent-lilac px-3 py-1 rounded-md text-sm font-medium hover:bg-opacity-80 transition-colors duration-200">+</button>
            </div>
            <div id="assignmentList" class="space-y-3">
                 <p class="text-gray-400 italic">No assignments tracked yet.</p>
            </div>
        </section>

    </main>

    <footer class="bg-gray-900 text-center text-xs text-gray-500 p-3 mt-6">
        Academic Dashboard &copy; 2025
    </footer>

    <div id="manageRoutineModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('manageRoutineModal')">&times;</span>
            <h3 class="text-lg font-semibold mb-4 accent-lilac-text">Manage Weekly Class Routine</h3>
            <form id="addRoutineItemForm" class="mb-6 pb-4 border-b border-gray-600">
                <h4 class="text-md font-semibold mb-2 text-gray-300">Add Class to Routine</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                    <div><label for="routineClassName">Class Name:</label><input type="text" id="routineClassName" name="routineClassName" required></div>
                    <div><label for="routineDay">Day of Week:</label><select id="routineDay" name="routineDay" required><option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option><option value="0">Sunday</option></select></div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                     <div><label for="routineStartTime">Start Time:</label><input type="time" id="routineStartTime" name="routineStartTime" required></div>
                     <div><label for="routineEndTime">End Time:</label><input type="time" id="routineEndTime" name="routineEndTime"></div>
                 </div>
                 <div><label for="routineLocation">Location/Link:</label><input type="text" id="routineLocation" name="routineLocation"></div>
                <button type="submit" class="w-full md:w-auto accent-lilac mt-2 py-2 px-4 rounded-md hover:bg-opacity-80 transition-colors duration-200">Add to Routine</button>
            </form>
            <h4 class="text-md font-semibold mb-2 text-gray-300">Current Routine</h4>
            <div id="currentRoutineList" class="space-y-2 max-h-60 overflow-y-auto"><p class="text-gray-400 italic">No routine set yet.</p></div>
        </div>
    </div>
    <div id="addExamModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addExamModal')">&times;</span>
            <h3 class="text-lg font-semibold mb-3 accent-lilac-text">Add New Exam</h3>
            <form id="addExamForm">
                <label for="examName">Exam Name/Subject:</label><input type="text" id="examName" name="examName" required>
                <label for="examDateTime">Date & Time:</label><input type="datetime-local" id="examDateTime" name="examDateTime" required>
                <label for="examSyllabus">Syllabus (Optional):</label><input type="file" id="examSyllabus" name="examSyllabus" accept=".pdf,.doc,.docx,.txt">
                 <p class="text-xs text-gray-400 -mt-2 mb-3">Note: File is not actually uploaded, only the name is stored.</p>
                <button type="submit" class="w-full accent-lilac mt-4 py-2 rounded-md hover:bg-opacity-80 transition-colors duration-200">Add Exam</button>
            </form>
        </div>
    </div>
    <div id="addNoteModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addNoteModal')">&times;</span>
            <h3 class="text-lg font-semibold mb-3 accent-lilac-text">Add Class Note</h3>
            <form id="addNoteForm">
                <label for="noteSubject">Subject/Course:</label><input type="text" id="noteSubject" name="noteSubject" required>
                <label for="noteTitle">Note Title/Topic:</label><input type="text" id="noteTitle" name="noteTitle" required>
                <label for="noteLink">Note Link (URL):</label><input type="url" id="noteLink" name="noteLink" placeholder="https://..." required>
                <button type="submit" class="w-full accent-lilac mt-4 py-2 rounded-md hover:bg-opacity-80 transition-colors duration-200">Add Note</button>
            </form>
        </div>
    </div>
     <div id="addAssignmentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addAssignmentModal')">&times;</span>
            <h3 class="text-lg font-semibold mb-3 accent-lilac-text">Add New Assignment</h3>
            <form id="addAssignmentForm">
                <label for="assignmentName">Assignment Name/Task:</label><input type="text" id="assignmentName" name="assignmentName" required>
                 <label for="assignmentSubject">Subject/Course:</label><input type="text" id="assignmentSubject" name="assignmentSubject">
                <label for="assignmentDueDate">Due Date:</label><input type="date" id="assignmentDueDate" name="assignmentDueDate" required>
                <button type="submit" class="w-full accent-lilac mt-4 py-2 rounded-md hover:bg-opacity-80 transition-colors duration-200">Add Assignment</button>
            </form>
        </div>
    </div>
    <div id="notificationToast" class="notification-toast">This is a notification!</div>


    <script>
        // --- Constants and State ---
        const CLASS_REMINDER_MINUTES = 40;
        const ASSIGNMENT_REMINDER_HOURS = 24;
        const DAYS_OF_WEEK = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        let classStatusInterval = null; // To hold the interval ID for the status timer

        // --- DOM Elements ---
        const weeklyClassViewEl = document.getElementById('weeklyClassView');
        const currentRoutineListEl = document.getElementById('currentRoutineList');
        const examListEl = document.getElementById('examList');
        const noteListEl = document.getElementById('noteList');
        const assignmentListEl = document.getElementById('assignmentList');
        const notificationToast = document.getElementById('notificationToast');
        // New elements for class status
        const currentClassInfoEl = document.getElementById('currentClassInfo');
        const nextClassInfoEl = document.getElementById('nextClassInfo');
        const countdownTimerEl = document.getElementById('countdownTimer');


        // --- Utility Functions ---
        const getData = (key) => JSON.parse(localStorage.getItem(key)) || [];
        const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

        // Format Time (HH:MM AM/PM)
        const formatTime = (timeString) => {
             if (!timeString) return '';
             try {
                 const [hours, minutes] = timeString.split(':');
                 const date = new Date(); date.setHours(parseInt(hours, 10), parseInt(minutes, 10), 0, 0);
                 return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
             } catch (e) { console.error("Error formatting time:", timeString, e); return 'Invalid Time'; }
         };

        // Format Date and Time
        const formatDateTime = (isoString) => {
            if (!isoString) return 'N/A';
            try {
                const date = new Date(isoString); if (isNaN(date)) return 'Invalid Date';
                return date.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
            } catch (e) { console.error("Error formatting date:", isoString, e); return 'Invalid Date'; }
        };

        // Format Date only
        const formatDate = (isoString) => {
             if (!isoString) return 'N/A';
             const dateStr = isoString.includes('T') ? isoString : `${isoString}T00:00:00`;
             try {
                 const date = new Date(dateStr); if (isNaN(date)) return 'Invalid Date';
                 return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
             } catch (e) { console.error("Error formatting date:", isoString, e); return 'Invalid Date'; }
        };

        // Format Date for Notes
        const formatNoteDate = (isoString) => {
            if (!isoString) return 'N/A';
            try {
                const date = new Date(isoString); if (isNaN(date)) return 'Invalid Date';
                return date.toLocaleDateString('en-US', { dateStyle: 'medium' });
            } catch (e) { console.error("Error formatting note date:", isoString, e); return 'Invalid Date'; }
        };

        // Show Custom Toast Notification
        const showToast = (message) => {
            notificationToast.textContent = message;
            notificationToast.style.display = 'block';
            setTimeout(() => { notificationToast.style.display = 'none'; }, 5000);
        };

        // --- Modal Handling ---
        const openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block'; modal.offsetWidth;
                modal.querySelector('.modal-content').classList.remove('slide-out');
                if (modalId === 'manageRoutineModal') renderCurrentRoutine();
            }
        };
        const closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                const modalContent = modal.querySelector('.modal-content');
                modalContent.classList.add('slide-out');
                setTimeout(() => { modal.style.display = 'none'; modalContent.classList.remove('slide-out'); }, 300);
            }
        };
        window.onclick = (event) => {
            document.querySelectorAll('.modal').forEach(modal => { if (event.target == modal) closeModal(modal.id); });
        };

        // --- Rendering Functions ---

        // Render Weekly Class View (No change from previous version)
        const renderWeeklyClasses = () => {
            const routine = getData('weeklyRoutine'); weeklyClassViewEl.innerHTML = '';
            if (routine.length === 0) { weeklyClassViewEl.innerHTML = '<p class="text-gray-400 italic">No weekly routine set. Click "Manage Routine" to add classes.</p>'; return; }
            const today = new Date(); const currentDayOfWeek = today.getDay();
            const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - currentDayOfWeek); startOfWeek.setHours(0, 0, 0, 0);
            const weekContainer = document.createElement('div'); weekContainer.className = 'grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-7 gap-3';
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek); dayDate.setDate(startOfWeek.getDate() + i);
                const dayColumn = document.createElement('div'); dayColumn.className = 'bg-gray-700 p-3 rounded-md day-column';
                const dayName = DAYS_OF_WEEK[i]; const dateString = dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const isToday = dayDate.toDateString() === today.toDateString();
                dayColumn.innerHTML = `<h4 class="font-semibold text-sm mb-2 ${isToday ? 'accent-lilac-text underline' : 'text-gray-300'}">${dayName} (${dateString})</h4>`;
                const classesForDay = routine.filter(item => parseInt(item.day, 10) === i).sort((a, b) => (a.startTime || '').localeCompare(b.startTime || ''));
                const classItemsContainer = document.createElement('div'); classItemsContainer.className = 'space-y-2';
                if (classesForDay.length === 0) { classItemsContainer.innerHTML = `<p class="text-xs text-gray-500 italic">No classes</p>`; }
                else { classesForDay.forEach(cls => {
                        const classDiv = document.createElement('div'); classDiv.className = 'bg-gray-600 p-2 rounded text-xs';
                        classDiv.innerHTML = `<p class="font-medium text-white">${cls.name}</p><p class="text-gray-300">${formatTime(cls.startTime)}${cls.endTime ? ' - ' + formatTime(cls.endTime) : ''}</p>${cls.location ? `<p class="text-gray-400 truncate" title="${cls.location}">${cls.location}</p>` : ''}`;
                        classItemsContainer.appendChild(classDiv); }); }
                dayColumn.appendChild(classItemsContainer); weekContainer.appendChild(dayColumn);
            } weeklyClassViewEl.appendChild(weekContainer);
        };

        // Render Current Routine in Modal (No change from previous version)
        const renderCurrentRoutine = () => {
            const routine = getData('weeklyRoutine').sort((a,b) => { if (a.day !== b.day) return parseInt(a.day) - parseInt(b.day); return (a.startTime || '').localeCompare(b.startTime || ''); });
            currentRoutineListEl.innerHTML = '';
            if (routine.length === 0) { currentRoutineListEl.innerHTML = '<p class="text-gray-400 italic">No routine set yet.</p>'; return; }
            routine.forEach(item => {
                const div = document.createElement('div'); div.className = 'bg-gray-700 p-2 rounded-md flex justify-between items-center text-sm';
                div.innerHTML = `<div><p class="font-medium">${item.name} (${DAYS_OF_WEEK[item.day]})</p><p class="text-xs text-gray-300">${formatTime(item.startTime)}${item.endTime ? ' - ' + formatTime(item.endTime) : ''} ${item.location ? ' - ' + item.location : ''}</p></div><button class="text-red-400 hover:text-red-600 text-xs" onclick="deleteItem('weeklyRoutine', '${item.id}')">Delete</button>`;
                currentRoutineListEl.appendChild(div);
            });
        };

        // Render Exams (No change)
        const renderExams = () => { /* ... content identical to previous version ... */
            const exams = getData('exams').sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
            examListEl.innerHTML = '';
            if (exams.length === 0) { examListEl.innerHTML = '<p class="text-gray-400 italic">No exams scheduled yet.</p>'; return; }
            exams.forEach(exam => {
                const div = document.createElement('div'); div.className = 'bg-gray-700 p-3 rounded-md text-sm';
                div.innerHTML = `<div class="flex justify-between items-start mb-1"><p class="font-medium">${exam.name}</p><button class="text-red-400 hover:text-red-600 text-xs ml-2" onclick="deleteItem('exams', '${exam.id}')">Delete</button></div><p class="text-xs text-gray-400 mb-1">Date: ${formatDateTime(exam.dateTime)}</p>${exam.syllabusName ? `<p class="text-xs text-gray-400">Syllabus: ${exam.syllabusName} <span class="italic text-gray-500">(file name only)</span></p>` : ''}`;
                examListEl.appendChild(div);
            });
        };

        // Render Notes (No change)
        const renderNotes = () => { /* ... content identical to previous version ... */
            const notes = getData('notes').sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
            noteListEl.innerHTML = '';
            if (notes.length === 0) { noteListEl.innerHTML = '<p class="text-gray-400 italic">No notes added yet.</p>'; return; }
            notes.forEach(note => {
                const div = document.createElement('div'); div.className = 'bg-gray-700 p-3 rounded-md text-sm';
                const isValidLink = note.link && (note.link.startsWith('http://') || note.link.startsWith('https://'));
                div.innerHTML = `<div class="flex justify-between items-start mb-1"><div><p class="font-medium">${note.title}</p><p class="text-xs text-gray-400">${note.subject || 'No Subject'}</p><p class="text-xs text-gray-500">Added: ${formatNoteDate(note.dateAdded)}</p></div><button class="text-red-400 hover:text-red-600 text-xs ml-2" onclick="deleteItem('notes', '${note.id}')">Delete</button></div>${isValidLink ? `<a href="${note.link}" target="_blank" rel="noopener noreferrer" class="text-xs accent-lilac-text hover:underline break-all">Link to Note</a>` : `<p class="text-xs text-gray-500 italic">${note.link ? 'Invalid or missing link' : 'No link provided'}</p>`}`;
                noteListEl.appendChild(div);
            });
        };

        // Render Assignments (No change)
        const renderAssignments = () => { /* ... content identical to previous version ... */
            const assignments = getData('assignments').sort((a, b) => new Date(a.dueDate + 'T00:00:00') - new Date(b.dueDate + 'T00:00:00'));
            assignmentListEl.innerHTML = '';
            if (assignments.length === 0) { assignmentListEl.innerHTML = '<p class="text-gray-400 italic">No assignments tracked yet.</p>'; return; }
            assignments.forEach(assignment => {
                const div = document.createElement('div');
                const dueDateStart = new Date(assignment.dueDate + 'T00:00:00'); const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                const isPastDue = todayStart > dueDateStart;
                div.className = `bg-gray-700 p-3 rounded-md text-sm ${isPastDue ? 'opacity-60' : ''}`;
                div.innerHTML = `<div class="flex justify-between items-start mb-1"><div><p class="font-medium">${assignment.name}</p>${assignment.subject ? `<p class="text-xs text-gray-500">${assignment.subject}</p>` : ''}</div><button class="text-red-400 hover:text-red-600 text-xs ml-2" onclick="deleteItem('assignments', '${assignment.id}')">Delete</button></div><p class="text-xs ${isPastDue ? 'text-red-400 font-medium' : 'text-gray-400'}">Due: ${formatDate(assignment.dueDate)} ${isPastDue ? '(Past Due)' : ''}</p>`;
                assignmentListEl.appendChild(div);
            });
        };

        // --- NEW: Update Class Status Section ---
        const updateClassStatus = () => {
            const now = new Date();
            const currentDay = now.getDay(); // 0=Sun, 1=Mon,...
            const currentTimeMs = now.getTime();

            const routine = getData('weeklyRoutine');
            const todayClasses = routine
                .filter(item => parseInt(item.day, 10) === currentDay && item.startTime) // Filter for today & ensure startTime exists
                .map(item => {
                    // Create Date objects for today's start and end times
                    const [startHours, startMinutes] = item.startTime.split(':').map(Number);
                    const startDate = new Date(now);
                    startDate.setHours(startHours, startMinutes, 0, 0);

                    let endDate = null;
                    if (item.endTime) {
                        const [endHours, endMinutes] = item.endTime.split(':').map(Number);
                        endDate = new Date(now);
                        endDate.setHours(endHours, endMinutes, 0, 0);
                        // Handle cases where end time is on the next day (e.g., class ends past midnight)
                        if (endDate < startDate) {
                            endDate.setDate(endDate.getDate() + 1);
                        }
                    }
                    return { ...item, startDate, endDate };
                })
                .sort((a, b) => a.startDate - b.startDate); // Sort by start Date object

            let currentClass = null;
            let nextClass = null;

            // Find current and next class
            for (const cls of todayClasses) {
                const startTimeMs = cls.startDate.getTime();
                // Use end time if available, otherwise consider class current if started and next hasn't
                const endTimeMs = cls.endDate ? cls.endDate.getTime() : Infinity;

                if (currentTimeMs >= startTimeMs && currentTimeMs < endTimeMs) {
                    // Basic check: current time is between start and end
                    currentClass = cls;
                    // Don't break yet, need to find the *next* class after this current one ends
                } else if (currentTimeMs < startTimeMs) {
                     // This is the first class starting after the current time
                     if (!nextClass) {
                         nextClass = cls;
                     }
                     // Optimization: if we found the current class OR the next class is the first one,
                     // and this class starts later than the found next class, we can stop searching for 'next'.
                     // However, the simple loop is fine here.
                 }

                 // More robust check for current class if end time is missing:
                 // If no end time, is it current if it started and the *next* class hasn't started yet?
                 if (!cls.endDate && currentTimeMs >= startTimeMs) {
                     // Find the *very next* scheduled class start time
                     const nextStartTimeInLoop = todayClasses.find(c => c.startDate.getTime() > startTimeMs)?.startDate.getTime() ?? Infinity;
                     if (currentTimeMs < nextStartTimeInLoop) {
                         currentClass = cls; // It's current until the next one begins
                     }
                 }

                 // If we found a current class, the *next* class is the one immediately following it in the sorted list
                 if (currentClass && cls.startDate.getTime() > currentClass.startDate.getTime() && !nextClass) {
                    nextClass = cls;
                    break; // Found current and the one right after it
                 }
            }


            // Update DOM Elements
            if (currentClass) {
                currentClassInfoEl.textContent = `${currentClass.name} (${formatTime(currentClass.startTime)}${currentClass.endTime ? ' - ' + formatTime(currentClass.endTime) : ''})`;
                currentClassInfoEl.title = currentClassInfoEl.textContent; // Set title for potential truncation
                currentClassInfoEl.classList.add('highlight');
            } else {
                currentClassInfoEl.textContent = 'No current class';
                currentClassInfoEl.title = '';
                currentClassInfoEl.classList.remove('highlight');
            }

            if (nextClass) {
                nextClassInfoEl.textContent = `${nextClass.name} at ${formatTime(nextClass.startTime)}`;
                 nextClassInfoEl.title = nextClassInfoEl.textContent;

                // Calculate countdown
                const timeDiffMs = nextClass.startDate.getTime() - currentTimeMs;
                if (timeDiffMs > 0) {
                    const totalSeconds = Math.floor(timeDiffMs / 1000);
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;
                    countdownTimerEl.textContent =
                        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                     countdownTimerEl.textContent = 'Starting...'; // Or handle if somehow negative
                }

            } else {
                nextClassInfoEl.textContent = 'No more classes today';
                nextClassInfoEl.title = '';
                countdownTimerEl.textContent = '--:--:--';
            }
        };


        // --- Event Handlers ---
        // Add Routine Item
        document.getElementById('addRoutineItemForm').addEventListener('submit', (e) => { /* ... content identical to previous version ... */
            e.preventDefault(); const name = document.getElementById('routineClassName').value; const day = document.getElementById('routineDay').value; const startTime = document.getElementById('routineStartTime').value; const endTime = document.getElementById('routineEndTime').value; const location = document.getElementById('routineLocation').value;
            const routine = getData('weeklyRoutine'); routine.push({ id: generateId(), name, day, startTime, endTime, location }); saveData('weeklyRoutine', routine);
            renderCurrentRoutine(); renderWeeklyClasses(); updateClassStatus(); // Update status on change
            e.target.reset(); showToast(`Class "${name}" added to routine.`);
        });
        // Add Exam
        document.getElementById('addExamForm').addEventListener('submit', (e) => { /* ... content identical to previous version ... */
            e.preventDefault(); const name = document.getElementById('examName').value; const dateTime = document.getElementById('examDateTime').value; const syllabusFile = document.getElementById('examSyllabus').files[0];
            const exams = getData('exams'); exams.push({ id: generateId(), name, dateTime, syllabusName: syllabusFile ? syllabusFile.name : null }); saveData('exams', exams);
            renderExams(); closeModal('addExamModal'); e.target.reset(); showToast(`Exam "${name}" added.`);
        });
        // Add Note
        document.getElementById('addNoteForm').addEventListener('submit', (e) => { /* ... content identical to previous version ... */
             e.preventDefault(); const subject = document.getElementById('noteSubject').value; const title = document.getElementById('noteTitle').value; const noteLink = document.getElementById('noteLink').value;
             const notes = getData('notes'); notes.push({ id: generateId(), subject, title, link: noteLink, dateAdded: new Date().toISOString() }); saveData('notes', notes);
             renderNotes(); closeModal('addNoteModal'); e.target.reset(); showToast(`Note "${title}" added.`);
        });
        // Add Assignment
        document.getElementById('addAssignmentForm').addEventListener('submit', (e) => { /* ... content identical to previous version ... */
             e.preventDefault(); const name = document.getElementById('assignmentName').value; const subject = document.getElementById('assignmentSubject').value; const dueDate = document.getElementById('assignmentDueDate').value;
             const assignments = getData('assignments'); assignments.push({ id: generateId(), name, subject, dueDate }); saveData('assignments', assignments);
             renderAssignments(); closeModal('addAssignmentModal'); e.target.reset(); showToast(`Assignment "${name}" added.`);
        });
        // Delete Item
        window.deleteItem = (key, id) => { /* ... content identical to previous version, but added updateClassStatus() call ... */
             if (!confirm('Are you sure you want to delete this item?')) return;
            let items = getData(key); const itemIndex = items.findIndex(item => item.id === id); let itemName = 'Item';
            if (itemIndex > -1) {
                 itemName = items[itemIndex].name || items[itemIndex].title || 'Item'; items = items.filter(item => item.id !== id); saveData(key, items);
                 if (key === 'weeklyRoutine') { renderCurrentRoutine(); renderWeeklyClasses(); updateClassStatus(); /* Update status on change */ }
                 else if (key === 'exams') renderExams(); else if (key === 'notes') renderNotes(); else if (key === 'assignments') renderAssignments();
                 showToast(`"${itemName}" deleted.`);
            }
        };

        // --- Notification Logic --- (No changes in this section)
        const requestNotificationPermission = () => { /* ... content identical to previous version ... */
            if (!("Notification" in window)) { showToast("Notifications not supported."); return false; } if (Notification.permission === "granted") { return true; } if (Notification.permission !== "denied") { Notification.requestPermission().then(permission => { if (permission === "granted") { showToast("Notifications enabled!"); return true; } else { showToast("Notifications disabled."); return false; } }); } return false;
        };
        const showNotification = (title, body) => { /* ... content identical to previous version ... */
            if (Notification.permission === "granted") { try { new Notification(title, { body: body, tag: title + body }); } catch (e) { console.error("Error showing notification:", e); showToast(`${title}: ${body}`); } } else { showToast(`${title}: ${body}`); }
        };
        const checkReminders = () => { /* ... content identical to previous version ... */
            const now = new Date(); const currentDay = now.getDay(); const currentTime = now.getHours() * 60 + now.getMinutes(); const reminderThreshold = CLASS_REMINDER_MINUTES; const assignmentThreshold = ASSIGNMENT_REMINDER_HOURS * 60 * 60 * 1000;
            const notifiedKey = 'notifiedEvents'; let notifiedEventsData = getData(notifiedKey).reduce((acc, item) => { if (item && item.id && item.time) acc[item.id] = item.time; return acc; }, {}); let updatedNotifiedEvents = false;
            const wasNotifiedRecently = (eventId) => { const lastNotifiedTime = notifiedEventsData[eventId]; if (!lastNotifiedTime) return false; return (now.getTime() - lastNotifiedTime) < (12 * 60 * 60 * 1000); }; const markAsNotified = (eventId) => { notifiedEventsData[eventId] = now.getTime(); updatedNotifiedEvents = true; };
            const routine = getData('weeklyRoutine'); routine.forEach(cls => { if (parseInt(cls.day, 10) === currentDay && cls.startTime) { try { const [startHours, startMinutes] = cls.startTime.split(':').map(Number); const classStartTimeMinutes = startHours * 60 + startMinutes; const timeDiffMinutes = classStartTimeMinutes - currentTime; const eventId = cls.id + '_routine_' + currentDay; if (timeDiffMinutes > 0 && timeDiffMinutes <= reminderThreshold && !wasNotifiedRecently(eventId)) { showNotification('Upcoming Class Reminder', `${cls.name} is starting in about ${timeDiffMinutes} minutes.`); markAsNotified(eventId); } } catch (e) { console.error("Error parsing routine class time:", cls.startTime, e); } } });
            const exams = getData('exams'); exams.forEach(exam => { const examTime = new Date(exam.dateTime); const timeDiff = examTime - now; const eventId = exam.id + '_exam'; if (timeDiff > 0 && timeDiff <= (CLASS_REMINDER_MINUTES * 60 * 1000) && !wasNotifiedRecently(eventId)) { showNotification('Upcoming Exam Reminder', `${exam.name} is starting in about ${CLASS_REMINDER_MINUTES} minutes.`); markAsNotified(eventId); } });
            const assignments = getData('assignments'); assignments.forEach(assignment => { const dueDateEnd = new Date(assignment.dueDate + 'T23:59:59'); const timeDiff = dueDateEnd - now; const eventId = assignment.id + '_assignment'; if (timeDiff > 0 && timeDiff <= assignmentThreshold && !wasNotifiedRecently(eventId)) { showNotification('Assignment Due Soon', `${assignment.name} is due tomorrow (${formatDate(assignment.dueDate)}).`); markAsNotified(eventId); } });
            const twoDaysAgo = now.getTime() - (2 * 24 * 60 * 60 * 1000); let cleanedNotifiedEvents = false; for (const eventId in notifiedEventsData) { if (notifiedEventsData[eventId] < twoDaysAgo) { delete notifiedEventsData[eventId]; cleanedNotifiedEvents = true; } } if (updatedNotifiedEvents || cleanedNotifiedEvents) { const eventsToSave = Object.entries(notifiedEventsData).map(([id, time]) => ({ id, time })); saveData(notifiedKey, eventsToSave); }
        };


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            requestNotificationPermission();

            // Initial rendering of all sections
            renderWeeklyClasses();
            renderExams();
            renderNotes();
            renderAssignments();
            updateClassStatus(); // Initial call for status section

            // Set up reminder checks (includes notifications)
            setInterval(checkReminders, 60 * 1000); // Check every 60 seconds
            checkReminders(); // Initial check immediately

            // Set up class status timer (updates countdown every second)
            if (classStatusInterval) clearInterval(classStatusInterval); // Clear previous interval if any
            classStatusInterval = setInterval(updateClassStatus, 1000); // Update status every second

            // Add event listeners for modal buttons
            document.getElementById('manageRoutineBtn').addEventListener('click', () => openModal('manageRoutineModal'));
            document.getElementById('addExamBtn').addEventListener('click', () => openModal('addExamModal'));
            document.getElementById('addNoteBtn').addEventListener('click', () => openModal('addNoteModal'));
            document.getElementById('addAssignmentBtn').addEventListener('click', () => openModal('addAssignmentModal'));
        });

    </script>

</body>
</html>
