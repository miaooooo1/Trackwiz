<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* White background */
            color: #1f2937; /* Dark gray text */
        }
        /* Lilac color theme */
        .bg-lilac-light { background-color: #f5f3ff; } /* Lighter lilac for backgrounds */
        .bg-lilac { background-color: #d8b4fe; } /* Main lilac */
        .text-lilac { color: #a855f7; } /* Lilac text */
        .border-lilac { border-color: #a855f7; }
        .ring-lilac { --tw-ring-color: #a855f7; }
        .hover\:bg-lilac-dark:hover { background-color: #9333ea; } /* Darker lilac on hover */

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #d8b4fe; /* Lilac scrollbar */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a855f7; /* Darker lilac on hover */
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Black background with opacity */
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem; /* Rounded corners */
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }
        /* Ensure inputs have good contrast and padding */
        input[type="text"], input[type="time"], input[type="date"], input[type="url"], select, textarea {
            border: 1px solid #d1d5db; /* Gray border */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* Rounded corners */
            width: 100%;
            margin-top: 0.25rem;
            margin-bottom: 0.75rem;
            color: #1f2937; /* Dark text for readability */
        }
        label {
            font-weight: 500;
            margin-bottom: 0.25rem;
            display: block;
        }
        /* Button styles */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn-primary {
            background-color: #a855f7; /* Lilac */
            color: white;
        }
        .btn-primary:hover {
            background-color: #9333ea; /* Darker Lilac */
        }
        .btn-secondary {
            background-color: #e5e7eb; /* Light Gray */
            color: #374151; /* Dark Gray Text */
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* Medium Gray */
        }
        .btn-danger {
            background-color: #ef4444; /* Red */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* Darker Red */
        }
        /* Tab styles */
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: border-color 0.3s ease, color 0.3s ease;
            font-weight: 500;
            color: #6b7280; /* Gray text for inactive tabs */
        }
        .tab-button.active {
            border-color: #a855f7; /* Lilac border */
            color: #a855f7; /* Lilac text */
        }
        .tab-button:hover {
            color: #a855f7;
        }
        .tab-content {
            display: none; /* Hide tab content by default */
        }
        .tab-content.active {
            display: block; /* Show active tab content */
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Card styles */
        .card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Notification prompt */
        #notification-prompt {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background-color: #1f2937; /* Dark background */
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 100;
            display: none; /* Hidden initially */
        }
         /* Custom message box */
        #message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: #1f2937; /* Dark background */
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 100;
            display: none; /* Hidden initially */
            max-width: 300px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #message-box.show {
            display: block;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-lilac-light min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-lilac mb-2">Academic Organizer</h1>
            <p class="text-gray-600">Your personal dashboard for classes, exams, and assignments.</p>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex justify-center space-x-4 md:space-x-8" aria-label="Tabs">
                <button class="tab-button active" data-tab="classes">Classes</button>
                <button class="tab-button" data-tab="exams">Exams</button>
                <button class="tab-button" data-tab="assignments">Assignments</button>
                <button class="tab-button" data-tab="notes">Class Notes</button>
            </nav>
        </div>

        <main>
            <div id="tab-classes" class="tab-content active">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Upcoming Classes</h2>
                    <button id="addClassBtn" class="btn btn-primary">Add Class</button>
                </div>
                <div id="weeklySchedule" class="space-y-4">
                    </div>
            </div>

            <div id="tab-exams" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Exams</h2>
                    <button id="addExamBtn" class="btn btn-primary">Add Exam</button>
                </div>
                <div id="examList" class="space-y-3">
                    </div>
            </div>

            <div id="tab-assignments" class="tab-content">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Assignments</h2>
                    <button id="addAssignmentBtn" class="btn btn-primary">Add Assignment</button>
                </div>
                <div id="assignmentList" class="space-y-3">
                    </div>
            </div>

            <div id="tab-notes" class="tab-content">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Class Notes (Sorted by Date)</h2>
                    <button id="addNoteBtn" class="btn btn-primary">Add Note Link</button>
                </div>
                 <div id="noteList" class="space-y-3">
                    </div>
            </div>
        </main>
    </div>

    <div id="classModal" class="modal">
        <div class="modal-content fade-in">
            <span class="close-button" onclick="closeModal('classModal')">&times;</span>
            <h3 id="classModalTitle" class="text-xl font-semibold mb-4">Add New Class</h3>
            <form id="classForm">
                <input type="hidden" id="classId"> <div>
                    <label for="classSubject">Subject/Course Name:</label>
                    <input type="text" id="classSubject" required>
                </div>
                <div>
                    <label for="classDay">Day of Week:</label>
                    <select id="classDay" required>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                        <option value="Sunday">Sunday</option>
                    </select>
                </div>
                <div>
                    <label for="classTime">Time:</label>
                    <input type="time" id="classTime" required>
                </div>
                 <div>
                    <label for="classLocation">Location (Optional):</label>
                    <input type="text" id="classLocation">
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('classModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Class</button>
                </div>
            </form>
        </div>
    </div>

    <div id="examModal" class="modal">
        <div class="modal-content fade-in">
            <span class="close-button" onclick="closeModal('examModal')">&times;</span>
            <h3 id="examModalTitle" class="text-xl font-semibold mb-4">Add New Exam</h3>
            <form id="examForm">
                 <input type="hidden" id="examId">
                 <div>
                    <label for="examSubject">Subject/Course Name:</label>
                    <input type="text" id="examSubject" required>
                </div>
                <div>
                    <label for="examDate">Date:</label>
                    <input type="date" id="examDate" required>
                </div>
                 <div>
                    <label for="examTime">Time:</label>
                    <input type="time" id="examTime" required>
                </div>
                <div>
                    <label for="examSyllabus">Syllabus Link (Optional):</label>
                    <input type="url" id="examSyllabus" placeholder="https://...">
                </div>
                 <div>
                    <label for="examLocation">Location (Optional):</label>
                    <input type="text" id="examLocation">
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('examModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Exam</button>
                </div>
            </form>
        </div>
    </div>

    <div id="assignmentModal" class="modal">
        <div class="modal-content fade-in">
             <span class="close-button" onclick="closeModal('assignmentModal')">&times;</span>
            <h3 id="assignmentModalTitle" class="text-xl font-semibold mb-4">Add New Assignment</h3>
            <form id="assignmentForm">
                 <input type="hidden" id="assignmentId">
                 <div>
                    <label for="assignmentSubject">Subject/Course Name:</label>
                    <input type="text" id="assignmentSubject" required>
                </div>
                <div>
                    <label for="assignmentDesc">Description:</label>
                    <textarea id="assignmentDesc" rows="3" required></textarea>
                </div>
                <div>
                    <label for="assignmentDueDate">Due Date:</label>
                    <input type="date" id="assignmentDueDate" required>
                </div>
                 <div>
                    <label for="assignmentDueTime">Due Time (Optional):</label>
                    <input type="time" id="assignmentDueTime">
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('assignmentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Assignment</button>
                </div>
            </form>
        </div>
    </div>

     <div id="noteModal" class="modal">
        <div class="modal-content fade-in">
             <span class="close-button" onclick="closeModal('noteModal')">&times;</span>
            <h3 id="noteModalTitle" class="text-xl font-semibold mb-4">Add New Note Link</h3>
            <form id="noteForm">
                 <input type="hidden" id="noteId">
                 <div>
                    <label for="noteSubject">Subject/Course Name:</label>
                    <input type="text" id="noteSubject" required>
                </div>
                <div>
                    <label for="noteTitle">Note Title/Description:</label>
                    <input type="text" id="noteTitle" required>
                </div>
                 <div>
                    <label for="noteDate">Date (Optional):</label>
                    <input type="date" id="noteDate">
                </div>
                 <div>
                    <label for="noteLink">Link to Note (PDF, Google Drive, etc.):</label>
                    <input type="url" id="noteLink" placeholder="https://" required>
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('noteModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Note Link</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification-prompt">
        <p class="mb-2">Enable notifications to get reminders?</p>
        <button id="enableNotificationsBtn" class="btn btn-primary text-sm mr-2">Enable</button>
        <button id="dismissNotificationsBtn" class="btn btn-secondary text-sm">Dismiss</button>
    </div>

    <div id="message-box">
        <p id="message-box-text"></p>
    </div>


    <script>
        // --- Constants ---
        const LOCAL_STORAGE_KEYS = {
            CLASSES: 'academicOrganizer_classes',
            EXAMS: 'academicOrganizer_exams',
            ASSIGNMENTS: 'academicOrganizer_assignments',
            NOTES: 'academicOrganizer_notes',
            NOTIFICATIONS_ENABLED: 'academicOrganizer_notificationsEnabled',
            NOTIFIED_EVENTS: 'academicOrganizer_notifiedEvents' // Store IDs of events already notified
        };
        const NOTIFICATION_LEAD_TIME_MINUTES = 40; // Remind 40 minutes before class/exam
        const ASSIGNMENT_DUE_SOON_HOURS = 24; // Notify if assignment due within 24 hours
        const DELETE_CONFIRM_MSG = "Hold up!"; // *** UPDATED: Custom delete confirmation message ***

        // --- Utility Functions ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // Get data from localStorage
        const getData = (key) => JSON.parse(localStorage.getItem(key) || '[]');

        // Save data to localStorage
        const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));

        // Generate unique ID
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

        // Format time (e.g., 14:30 -> 2:30 PM)
        const formatTime = (timeString) => {
            if (!timeString) return '';
            const [hour, minute] = timeString.split(':');
            const hourNum = parseInt(hour, 10);
            const ampm = hourNum >= 12 ? 'PM' : 'AM';
            const formattedHour = hourNum % 12 || 12; // Convert 0 to 12 for 12 AM/PM
            return `${formattedHour}:${minute} ${ampm}`;
        };

        // Format date (e.g., 2025-04-18 -> April 18, 2025)
        const formatDate = (dateString) => {
            if (!dateString) return '';
            // Add T00:00:00 to ensure consistent parsing across browsers, treating it as local time
            const date = new Date(dateString + 'T00:00:00');
             return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // Show custom message
        const showMessage = (text, duration = 3000) => {
            const box = $('#message-box');
            const boxText = $('#message-box-text');
            if (!box || !boxText) return;

            boxText.textContent = text;
            box.classList.add('show');

            // Clear any existing timer
            if (box.timerId) {
                clearTimeout(box.timerId);
            }
            // Set new timer
            box.timerId = setTimeout(() => {
                box.classList.remove('show');
                box.timerId = null; // Clear timerId after hiding
            }, duration);
        }

        // --- Modal Handling ---
        const openModal = (modalId, data = null) => {
            const modal = $(`#${modalId}`);
            const form = modal.querySelector('form');
            const title = modal.querySelector('h3');
            form.reset(); // Clear previous data
            form.querySelector('input[type="hidden"]').value = ''; // Clear ID

            if (data) { // Editing existing item
                title.textContent = title.textContent.replace('Add New', 'Edit');
                form.querySelector('input[type="hidden"]').value = data.id;
                // Populate form fields based on modal type
                switch (modalId) {
                    case 'classModal':
                        $('#classSubject').value = data.subject;
                        $('#classDay').value = data.day;
                        $('#classTime').value = data.time;
                        $('#classLocation').value = data.location || '';
                        break;
                    case 'examModal':
                         $('#examSubject').value = data.subject;
                        $('#examDate').value = data.date;
                        $('#examTime').value = data.time;
                        $('#examSyllabus').value = data.syllabusLink || '';
                        $('#examLocation').value = data.location || '';
                        break;
                    case 'assignmentModal':
                        $('#assignmentSubject').value = data.subject;
                        $('#assignmentDesc').value = data.description;
                        $('#assignmentDueDate').value = data.dueDate;
                        $('#assignmentDueTime').value = data.dueTime || '';
                        break;
                    case 'noteModal':
                        $('#noteSubject').value = data.subject;
                        $('#noteTitle').value = data.title;
                        $('#noteLink').value = data.link;
                        $('#noteDate').value = data.date || ''; // Populate date field
                        break;
                }
            } else { // Adding new item
                 title.textContent = title.textContent.replace('Edit', 'Add New');
            }

            modal.style.display = 'block';
        };

        const closeModal = (modalId) => {
            $(`#${modalId}`).style.display = 'none';
        };

        // Close modal if clicked outside of content
        window.onclick = (event) => {
            $$('.modal').forEach(modal => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // --- Data Storage & Retrieval ---
        let classes = getData(LOCAL_STORAGE_KEYS.CLASSES);
        let exams = getData(LOCAL_STORAGE_KEYS.EXAMS);
        let assignments = getData(LOCAL_STORAGE_KEYS.ASSIGNMENTS);
        let notes = getData(LOCAL_STORAGE_KEYS.NOTES);
        let notifiedEvents = getData(LOCAL_STORAGE_KEYS.NOTIFIED_EVENTS); // Track notified events

        // --- Rendering Functions ---

        // Render Weekly Class Schedule
        const renderClasses = () => {
            const scheduleContainer = $('#weeklySchedule');
            scheduleContainer.innerHTML = ''; // Clear existing schedule
            const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

            daysOfWeek.forEach(day => {
                const dayClasses = classes
                    .filter(c => c.day === day)
                    .sort((a, b) => a.time.localeCompare(b.time)); // Sort classes by time

                const dayCard = document.createElement('div');
                dayCard.className = 'card bg-white'; // Use card style

                let content = `<h3 class="text-lg font-semibold mb-3 text-lilac border-b border-lilac pb-1">${day}</h3>`;
                if (dayClasses.length > 0) {
                    content += '<ul class="space-y-2">';
                    dayClasses.forEach(c => {
                        content += `
                            <li class="flex justify-between items-center p-2 rounded hover:bg-lilac-light transition duration-150">
                                <div>
                                    <span class="font-medium">${c.subject}</span>
                                    <span class="text-sm text-gray-600 ml-2">${formatTime(c.time)}</span>
                                    ${c.location ? `<span class="text-sm text-gray-500 ml-2 italic">(${c.location})</span>` : ''}
                                </div>
                                <div class="space-x-1">
                                    <button class="text-blue-500 hover:text-blue-700 text-xs" onclick="editClass('${c.id}')">Edit</button>
                                    <button class="text-red-500 hover:text-red-700 text-xs" onclick="deleteClass('${c.id}')">Delete</button>
                                </div>
                            </li>
                        `;
                    });
                    content += '</ul>';
                } else {
                    content += '<p class="text-gray-500 text-sm">No classes scheduled.</p>';
                }
                dayCard.innerHTML = content;
                scheduleContainer.appendChild(dayCard);
            });
             if (classes.length === 0) {
                 scheduleContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">No classes added yet. Click "Add Class" to start.</p>';
            }
        };

        // Render Exams
        const renderExams = () => {
            const listContainer = $('#examList');
            listContainer.innerHTML = ''; // Clear list
            exams.sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time)); // Sort by date and time

            if (exams.length === 0) {
                 listContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">No exams added yet.</p>';
                 return;
            }

            exams.forEach(exam => {
                const item = document.createElement('div');
                item.className = 'card flex justify-between items-start'; // Use card style
                item.innerHTML = `
                    <div>
                        <h4 class="font-semibold text-lg">${exam.subject}</h4>
                        <p class="text-sm text-gray-600">Date: ${formatDate(exam.date)} at ${formatTime(exam.time)}</p>
                        ${exam.location ? `<p class="text-sm text-gray-500 italic">Location: ${exam.location}</p>` : ''}
                        ${exam.syllabusLink ? `<a href="${exam.syllabusLink}" target="_blank" rel="noopener noreferrer" class="text-sm text-lilac hover:underline mt-1 inline-block">View Syllabus</a>` : '<p class="text-sm text-gray-400 mt-1">No syllabus link</p>'}
                    </div>
                    <div class="flex flex-col space-y-1 items-end ml-4">
                        <button class="btn btn-secondary btn-sm text-xs" onclick="editExam('${exam.id}')">Edit</button>
                        <button class="btn btn-danger btn-sm text-xs" onclick="deleteExam('${exam.id}')">Delete</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        };

        // Render Assignments
        const renderAssignments = () => {
            const listContainer = $('#assignmentList');
            listContainer.innerHTML = ''; // Clear list
            assignments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)); // Sort by due date

             if (assignments.length === 0) {
                 listContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">No assignments added yet.</p>';
                 return;
            }

            assignments.forEach(assignment => {
                const item = document.createElement('div');
                item.className = 'card flex justify-between items-start'; // Use card style
                 const dueDate = new Date(assignment.dueDate + 'T' + (assignment.dueTime || '00:00'));
                 const isPastDue = dueDate < new Date();

                item.innerHTML = `
                    <div class="${isPastDue ? 'opacity-60' : ''}">
                        <h4 class="font-semibold text-lg">${assignment.subject}</h4>
                        <p class="text-sm text-gray-700 my-1">${assignment.description}</p>
                        <p class="text-sm ${isPastDue ? 'text-red-600 font-medium' : 'text-gray-600'}">
                            Due: ${formatDate(assignment.dueDate)} ${assignment.dueTime ? 'at ' + formatTime(assignment.dueTime) : ''}
                            ${isPastDue ? ' (Past Due)' : ''}
                        </p>
                    </div>
                    <div class="flex flex-col space-y-1 items-end ml-4">
                        <button class="btn btn-secondary btn-sm text-xs" onclick="editAssignment('${assignment.id}')">Edit</button>
                        <button class="btn btn-danger btn-sm text-xs" onclick="deleteAssignment('${assignment.id}')">Delete</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        };

        // Render Notes sorted by Date
        const renderNotes = () => {
            const listContainer = $('#noteList');
            listContainer.innerHTML = ''; // Clear list

             if (notes.length === 0) {
                 listContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">No notes added yet.</p>';
                 return;
            }

            // Separate notes with and without dates
            const datedNotes = notes.filter(note => note.date);
            const undatedNotes = notes.filter(note => !note.date);

            // Sort dated notes: newest first (descending)
            datedNotes.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Combine sorted dated notes and undated notes (undated appear last)
            const sortedNotes = [...datedNotes, ...undatedNotes];

            sortedNotes.forEach(note => {
                const item = document.createElement('div');
                item.className = 'card flex justify-between items-start'; // Use card style

                item.innerHTML = `
                    <div>
                        <h4 class="font-semibold text-lg">${note.title}</h4>
                        <p class="text-sm text-gray-600">Subject: ${note.subject}</p>
                        ${note.date ? `<p class="text-sm text-gray-500">Date: ${formatDate(note.date)}</p>` : '<p class="text-sm text-gray-400">Date: Not specified</p>'}
                        <a href="${note.link}" target="_blank" rel="noopener noreferrer" class="text-sm text-lilac hover:underline mt-1 inline-block">View Note</a>
                    </div>
                    <div class="flex flex-col space-y-1 items-end ml-4">
                        <button class="btn btn-secondary btn-sm text-xs" onclick="editNote('${note.id}')">Edit</button>
                        <button class="btn btn-danger btn-sm text-xs" onclick="deleteNote('${note.id}')">Delete</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        };


        // --- CRUD Operations ---

        // Add or Update Class
        $('#classForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = $('#classId').value;
            const newClass = {
                id: id || generateId(),
                subject: $('#classSubject').value.trim(),
                day: $('#classDay').value,
                time: $('#classTime').value,
                location: $('#classLocation').value.trim()
            };

            if (id) { // Update existing
                classes = classes.map(c => c.id === id ? newClass : c);
                showMessage('Class updated successfully!');
            } else { // Add new
                classes.push(newClass);
                showMessage('Class added successfully!');
            }
            saveData(LOCAL_STORAGE_KEYS.CLASSES, classes);
            renderClasses();
            closeModal('classModal');
        });

        // Edit Class
        window.editClass = (id) => {
            const classToEdit = classes.find(c => c.id === id);
            if (classToEdit) {
                openModal('classModal', classToEdit);
            }
        };

        // Delete Class
        window.deleteClass = (id) => {
            // *** UPDATED: Use custom confirmation message ***
            if (confirm(DELETE_CONFIRM_MSG)) {
                classes = classes.filter(c => c.id !== id);
                saveData(LOCAL_STORAGE_KEYS.CLASSES, classes);
                renderClasses();
                showMessage('Class deleted.');
            }
        };

        // Add or Update Exam
        $('#examForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = $('#examId').value;
            const newExam = {
                id: id || generateId(),
                subject: $('#examSubject').value.trim(),
                date: $('#examDate').value,
                time: $('#examTime').value,
                syllabusLink: $('#examSyllabus').value.trim(),
                location: $('#examLocation').value.trim()
            };

            if (id) {
                exams = exams.map(ex => ex.id === id ? newExam : ex);
                 showMessage('Exam updated successfully!');
            } else {
                exams.push(newExam);
                 showMessage('Exam added successfully!');
            }
            saveData(LOCAL_STORAGE_KEYS.EXAMS, exams);
            renderExams();
            closeModal('examModal');
        });

         // Edit Exam
        window.editExam = (id) => {
            const examToEdit = exams.find(ex => ex.id === id);
            if (examToEdit) {
                openModal('examModal', examToEdit);
            }
        };

        // Delete Exam
        window.deleteExam = (id) => {
             // *** UPDATED: Use custom confirmation message ***
            if (confirm(DELETE_CONFIRM_MSG)) {
                exams = exams.filter(ex => ex.id !== id);
                saveData(LOCAL_STORAGE_KEYS.EXAMS, exams);
                renderExams();
                showMessage('Exam deleted.');
            }
        };

         // Add or Update Assignment
        $('#assignmentForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = $('#assignmentId').value;
            const newAssignment = {
                id: id || generateId(),
                subject: $('#assignmentSubject').value.trim(),
                description: $('#assignmentDesc').value.trim(),
                dueDate: $('#assignmentDueDate').value,
                dueTime: $('#assignmentDueTime').value
            };

            if (id) {
                assignments = assignments.map(a => a.id === id ? newAssignment : a);
                 showMessage('Assignment updated successfully!');
            } else {
                assignments.push(newAssignment);
                 showMessage('Assignment added successfully!');
            }
            saveData(LOCAL_STORAGE_KEYS.ASSIGNMENTS, assignments);
            renderAssignments();
            closeModal('assignmentModal');
        });

         // Edit Assignment
        window.editAssignment = (id) => {
            const assignmentToEdit = assignments.find(a => a.id === id);
            if (assignmentToEdit) {
                openModal('assignmentModal', assignmentToEdit);
            }
        };

        // Delete Assignment
        window.deleteAssignment = (id) => {
             // *** UPDATED: Use custom confirmation message ***
            if (confirm(DELETE_CONFIRM_MSG)) {
                assignments = assignments.filter(a => a.id !== id);
                saveData(LOCAL_STORAGE_KEYS.ASSIGNMENTS, assignments);
                renderAssignments();
                 showMessage('Assignment deleted.');
            }
        };

        // Add or Update Note (with date)
        $('#noteForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = $('#noteId').value;
            const newNote = {
                id: id || generateId(),
                subject: $('#noteSubject').value.trim(),
                title: $('#noteTitle').value.trim(),
                date: $('#noteDate').value || null, // Store date, or null if empty
                link: $('#noteLink').value.trim()
            };

             // Basic URL validation
            try {
                new URL(newNote.link);
            } catch (_) {
                showMessage('Please enter a valid URL for the note link.', 4000);
                return;
            }


            if (id) {
                notes = notes.map(n => n.id === id ? newNote : n);
                 showMessage('Note link updated successfully!');
            } else {
                notes.push(newNote);
                 showMessage('Note link added successfully!');
            }
            saveData(LOCAL_STORAGE_KEYS.NOTES, notes);
            renderNotes(); // Re-render the updated notes list
            closeModal('noteModal');
        });

         // Edit Note
        window.editNote = (id) => {
            const noteToEdit = notes.find(n => n.id === id);
            if (noteToEdit) {
                openModal('noteModal', noteToEdit);
            }
        };

        // Delete Note
        window.deleteNote = (id) => {
             // *** UPDATED: Use custom confirmation message ***
            if (confirm(DELETE_CONFIRM_MSG)) {
                notes = notes.filter(n => n.id !== id);
                saveData(LOCAL_STORAGE_KEYS.NOTES, notes);
                renderNotes();
                 showMessage('Note link deleted.');
            }
        };


        // --- Tab Switching ---
        const tabs = $$('.tab-button');
        const tabContents = $$('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Deactivate all tabs and content
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                // Activate clicked tab and corresponding content
                tab.classList.add('active');
                const targetTab = tab.getAttribute('data-tab');
                $(`#tab-${targetTab}`).classList.add('active');
            });
        });

        // --- Notifications ---
        let notificationsEnabled = localStorage.getItem(LOCAL_STORAGE_KEYS.NOTIFICATIONS_ENABLED) === 'true';
        const notificationPrompt = $('#notification-prompt');

        // Function to request notification permission
        const requestNotificationPermission = () => {
            if (!('Notification' in window)) {
                showMessage('This browser does not support desktop notification.', 5000);
                return;
            }

            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    notificationsEnabled = true;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.NOTIFICATIONS_ENABLED, 'true');
                    notificationPrompt.style.display = 'none';
                    showMessage('Notifications enabled!');
                    checkUpcomingEvents(); // Run check immediately after enabling
                } else {
                    notificationsEnabled = false;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.NOTIFICATIONS_ENABLED, 'false');
                     showMessage('Notifications permission denied.', 4000);
                }
            });
        };

        // Show prompt if permission not granted or denied yet
        if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
             notificationPrompt.style.display = 'block';
        }

        $('#enableNotificationsBtn').addEventListener('click', requestNotificationPermission);
        $('#dismissNotificationsBtn').addEventListener('click', () => {
            notificationPrompt.style.display = 'none';
        });


        // Function to send a notification
        const sendNotification = (title, options) => {
            if (!notificationsEnabled || Notification.permission !== 'granted') {
                return; // Don't send if not enabled or permission denied
            }
            // Add a default icon if none provided
            const defaultOptions = {
                 icon: 'https://placehold.co/48x48/d8b4fe/ffffff?text=ðŸ””' // Default Lilac Bell
            };
            new Notification(title, { ...defaultOptions, ...options });
        };

         // Mark an event as notified
        const markAsNotified = (eventId) => {
            if (!notifiedEvents.includes(eventId)) {
                notifiedEvents.push(eventId);
                // Limit the size of notifiedEvents to prevent excessive storage use
                if (notifiedEvents.length > 100) {
                    notifiedEvents = notifiedEvents.slice(-100); // Keep only the last 100
                }
                saveData(LOCAL_STORAGE_KEYS.NOTIFIED_EVENTS, notifiedEvents);
            }
        };

        // Check upcoming events and send notifications
        const checkUpcomingEvents = () => {
            if (!notificationsEnabled || Notification.permission !== 'granted') return;

            const now = new Date();
            const nowTime = now.getTime();
            const todayDay = now.toLocaleDateString('en-US', { weekday: 'long' }); // e.g., "Monday"

            // 1. Check Classes for today
            classes.forEach(cls => {
                if (cls.day === todayDay && cls.time) {
                    const [hour, minute] = cls.time.split(':');
                    const classDateTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(hour), parseInt(minute));
                    const classTime = classDateTime.getTime();
                    const timeDiffMinutes = (classTime - nowTime) / (1000 * 60);
                    const eventId = `class_${cls.id}_${now.toISOString().split('T')[0]}`; // Unique ID per day

                    if (timeDiffMinutes > 0 && timeDiffMinutes <= NOTIFICATION_LEAD_TIME_MINUTES) {
                        if (!notifiedEvents.includes(eventId)) {
                            sendNotification('Upcoming Class Reminder', {
                                body: `${cls.subject} starts at ${formatTime(cls.time)} ${cls.location ? 'in ' + cls.location : ''}.`
                            });
                            markAsNotified(eventId);
                        }
                    }
                }
            });

            // 2. Check Exams
            exams.forEach(exam => {
                 if (exam.date && exam.time) {
                    const examDateTime = new Date(`${exam.date}T${exam.time}`);
                    const examTime = examDateTime.getTime();
                    const timeDiffMinutes = (examTime - nowTime) / (1000 * 60);
                    const eventId = `exam_${exam.id}`;

                    if (timeDiffMinutes > 0 && timeDiffMinutes <= NOTIFICATION_LEAD_TIME_MINUTES) {
                         if (!notifiedEvents.includes(eventId)) {
                            sendNotification('Upcoming Exam Reminder', {
                                body: `${exam.subject} exam starts at ${formatTime(exam.time)} on ${formatDate(exam.date)}. ${exam.location ? 'Location: ' + exam.location : ''}`,
                                icon: 'https://placehold.co/48x48/d8b4fe/ffffff?text=â—' // Alert icon
                            });
                             markAsNotified(eventId);
                        }
                    }
                 }
            });

            // 3. Check Assignments Due Soon
            assignments.forEach(assignment => {
                 if (assignment.dueDate) {
                    const dueDateTime = new Date(`${assignment.dueDate}T${assignment.dueTime || '23:59:59'}`); // Assume end of day if no time
                    const dueTime = dueDateTime.getTime();
                    const timeDiffHours = (dueTime - nowTime) / (1000 * 60 * 60);
                    const eventId = `assignment_${assignment.id}`;

                    // Notify if due within the threshold and not already past due
                    if (timeDiffHours > 0 && timeDiffHours <= ASSIGNMENT_DUE_SOON_HOURS) {
                        if (!notifiedEvents.includes(eventId)) {
                             sendNotification('Assignment Due Soon', {
                                body: `${assignment.subject} - "${assignment.description.substring(0, 30)}..." is due on ${formatDate(assignment.dueDate)}.`,
                                icon: 'https://placehold.co/48x48/d8b4fe/ffffff?text=ðŸ“' // Note icon
                            });
                             markAsNotified(eventId);
                        }
                    }
                 }
            });

             // Clean up old notified events (older than 7 days) - Optional but good practice
            const sevenDaysAgo = nowTime - (7 * 24 * 60 * 60 * 1000);
            notifiedEvents = notifiedEvents.filter(eventId => {
                // Simple check: if it's a daily class event, parse date from ID
                if (eventId.startsWith('class_')) {
                    const parts = eventId.split('_');
                    if (parts.length === 3) {
                        try {
                            const eventDate = new Date(parts[2]).getTime();
                            return eventDate >= sevenDaysAgo;
                        } catch (e) { return true; } // Keep if date parsing fails
                    }
                }
                // Keep non-class events or those we can't parse date for (could improve this)
                return true;
            });
            saveData(LOCAL_STORAGE_KEYS.NOTIFIED_EVENTS, notifiedEvents);

        };

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            renderClasses();
            renderExams();
            renderAssignments();
            renderNotes(); // Render notes with the new sorting

            // Add event listeners for Add buttons
            $('#addClassBtn').addEventListener('click', () => openModal('classModal'));
            $('#addExamBtn').addEventListener('click', () => openModal('examModal'));
            $('#addAssignmentBtn').addEventListener('click', () => openModal('assignmentModal'));
            $('#addNoteBtn').addEventListener('click', () => openModal('noteModal'));

            // Check for notifications periodically (e.g., every minute)
            // Only start interval if permission might be granted later or is already granted
            if ('Notification' in window && Notification.permission !== 'denied') {
                 // Run first check shortly after load
                 setTimeout(checkUpcomingEvents, 5000); // Wait 5 seconds
                 // Then check every minute
                 setInterval(checkUpcomingEvents, 60 * 1000);
            } else if (Notification.permission === 'denied') {
                console.warn("Notification permission is denied. Reminders will not work.");
            }

            console.log("Academic Organizer App Loaded.");
        });

    </script>

</body>
</html>
